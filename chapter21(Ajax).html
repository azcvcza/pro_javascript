<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Ajax learning</title>
</head>

<body>

</body>
<script>
    //IE或者更早版本
    function createXHR() {
        if (typeof XMLHttpRequest != "undefined") {
            return new XMLHttpRequest();
        } else if (typeof ActiveXObject != "undefined") {
            if (typeof arguments.callee.activeXString != "string") {
                var versions = [
                    "MSXML2.XMLHttp.6.0",
                    "MSXML2.XMLHttp.3.0",
                    "MSXML2.XMLHttp"

                ]
                var i;
                var len;
                for (i = 0, len = versions.length; i < len; i++) {
                    try {
                        new ActiveXObject(versions[i]);
                        arguments.callee.activeXString = versions[i];
                        break;
                    } catch (ex) {
                        console.log("fail to new xml:", ex)
                    }
                }
            }
            return new ActiveXObject(arguments.callee.activeXString);
        } else {
            throw new Error("No XHR object available.")
        }
    }
    /*
    var xhr = createXHR();
    xhr.open("get","example.php",false)
    xhr.open("get","exmple.txt",false);
    xhr.send(null);
    if((xhr.status>=200 && xhr.status <300)|| xhr.status==304){
        console.log(xhr.responseText);
    }
    else{
        console.log("Request was unsuccessful:"+xhr.status);
    }
    //异步
     var xhr = createXHR();
     xhr.onreadystatechange= function(){
         if(xhr.readyState == 4){
             if((xhr.status>=200 && xhr.status <300)|| xhr.status==304){
                  console.log(xhr.responseText);
           }
          else{
                console.log("Request was unsuccessful:"+xhr.status);
              }
         }
     }
     //set header
      var myHeader = xhr.getResponseHeader("MyHeader");
      var allHeader = xhr.getAllResponseHeaders();
     //get 请求
      xhr.open("get","example.php?name=1=value&name=value2",true);
      function addURLParam(url,name,value){
          url += (url.indexOf("?")) == -1? "?":"&");
          url += encodeURIComponent(name) + "=" + encodeURIComponent(value);
          return url;
      }
      var url = "xxxx.php";
      url = addURLParam(url,"name","Nicoles");
      url = addURLParam(url,"book","fuck");
      xhr.oprn("get",url,false);
      //post 请求
      xhr.open("post","xxx.php",true);
      xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
      var form = document.getElementById("user-info");
      xhr.send(serialize(form));

      //timeout 
      xhr.timeout = 1000;
      xhr.ontimeout=function(){
          console.log("request did not returen in timeout");
      }
      xhr.send(null);
      // cors(跨域)
      function createCORSRequest(method,url){
          var xhr = new XMLHttpRequest();
          if("withCredentials" in xhr){
              xhr.open(method,url,true)
          }
          else if(typeof XDomainRequest !="undefined"){
              xhr = new XDomainRequest();
              xhr.open(method,url);
          }
          else{
              xhr = null
          }
          return xhr;
      }
      var request = createCORSRequest("get","xxxx.com/page")
      if(request){
          request.onload = function(){
              console.log(request)
          }
          request.send();
      }
      //跨域: 图形ping
      var img = new Image();
      img.onload = img.onerror = function(){
          console.log("done");
      }
      img.src = "xxx.com"

      //跨域 Comet
      //1. XHR 实现 HTTP流
       function createStreamingClient(url,progress,finished){
           var xhr = new XMLHttpRequest();
           var received = 0;
           xhr.open("get",url,true);
           xhr.onreadystatechange = function(){
               var result;
               if(xhr.readyState == 3){
                   result = xhr.responseText.substring(received);
                   received += result.length;
                   progress(result);
               }
               else if(xhr.readyState==4){
                   finished(xhr.responseText);
               }
           }
           xhr.send(null);
           return xhr;
       }
       var client = createStreamingClient("streaming.php",function(data{
           console.log("received: "+data);
       },
        function(data){
            console.log("done");
        }
        ))
        //服务器发送
        //1.sse api 
        var source = new EventSource("xxxx.php");
        source.onmessage = function(event){
            var data = event.data;
        }
        source.close();
        //2.web socket
        var socket = new WebSocket("xxx.php")
        socket.send("HelloWorld")
        var message = {
            time:new Date(),
            text:"Hello world",
            clientId:"ssafzcvz"
        };
        socket.send(JSON.stringify(message))
        socket.onmessage = function(event){
            var data = event.data();
            //deal with data
        }
        //state of socket
        socket.onopen = function(){
            console.log("connection build");
        }
        socket.onerror = function(){
            console.log("deal with error");
        }
        socket.onclose = function(){
            console.log("connection close")
            console.log("was clean?"+event.wasClean +"Code :"+event.code+"reason="+event.reason);
        }
        socket.close();


    */
</script>

</html>